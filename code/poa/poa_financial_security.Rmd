---
title: "poa_financial_security"
author: "Arielle Herman"
date: "4/3/2022"
output:
  pdf_document:
    toc: true
---

```{r include=F}
source("default_setup.R")
```

# Summary of Findings

1. Nearly every time, sch level was negatively associated with stress, and speaking a language other than English at home or having children was positively associated with stress.
2. Black and Hispanic respondents frequently experienced more stress than white respondents.


# Data Description

Data heavily skewed towards higher income brackets

```{r}
categories <- attributes(wrangled$inc_after)$labels

wrangled %>%
  select(inc_before, inc_after) %>%
  mutate_if(is.labelled, labelled::to_character) %>%
  count(inc_before)


arranged <- tibble(range = names(categories)) %>%
  left_join(wrangled %>% mutate(range = labelled::to_character(inc_before)) %>%
              count(range, inc_before)) %>%
  mutate(range = str_replace_all(range, c("less than" = "$0 -", "or more" = "- $450,000+"))) %>%
  separate(col = range, into = c("min", "max"), sep = " - ", remove = FALSE) %>%
  mutate(across(min:max, ~as.double(str_replace_all(., "\\$|,|\\+", "")))) %>%
  
  na.omit()# come back to top bracket later
  
inc_dist_plot <- arranged %>%
  
  ggplot(aes(y = reorder(range, max), alpha = n), show.legend = FALSE) +
  #geom_col(aes(x = max)) +
  geom_linerange(aes(xmin = min, xmax = max, size = n), color = project_pal[4], show.legend = FALSE) +
  geom_vline(xintercept = c(35000, 60000),
             labels = c("poverty line", "median income"), lty = "dashed") +
  geom_text(aes(x = max, label = n), hjust = -0.2, color = project_pal[4], size = 3, show.legend = FALSE) +
  scale_x_continuous(labels = scales::dollar) +
  #annotate("text", x = 0, y = c(poverty_line), label = c("Respondents\nBelow Poverty Line"))
  #geom_jitter(data = wrangled, aes(x = ))
  ylab("Income Bracket\n") + xlab("\nIncome Range") +
  ggtitle("Respondent Income Distribution\n")

inc_dist_plot


ggplot(data = wrangled, aes(x = inc_before)) + geom_bar(fill = project_pal[4])
```

# 2.1)Households that saw a reduction in income between 2019 and 2021 [12 &13]
Compare predicted 2021 income with 2019 income to find positive or negative change
Run distribution of negative changes over population
Run distribution by sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

## Findings (some statistically significant differences):

The greatest proportion of people to see a reduction in income throughout the pandemic by

- **employment status** were unemployed after the pandemic
- **income distribution** were inbetween the poverty line and the median income level


```{r}
plots2.1 <- make_plots(df = wrangled, by_vars = demographics, hyp_var = "inc_neg", min = 5,
           title = "Respondents who saw a reduction in household income", show = "yes")[c("inc_dist", "emp_status_before", "emp_status_after")]
plots2.1
```

This two plots grouped by employment status before and after the start of the pandemic suggests that the majority of respondents who experienced a reduction in income, were originally employed.  We can confirm this with the below graph.


```{r}
(became_unemp <- wrangled %>% filter(str_detect(emp_status_after, "unemp")) %>%
  #group_by(emp_status_before) %>%
    #group_by(inc_neg == 1) %>%
  summarize(n = sum(!str_detect(emp_status_before, "unemp") & inc_neg == 1, na.rm = TRUE),
            n_n = sum(inc_neg == 1, na.rm = TRUE),
            denom = sum(!is.na(!str_detect(emp_status_before, "unemp"))),
            prop = n/denom))

plots2.1$emp_status_after +
  geom_col(data = tibble(emp_status_after = "Unemployed", prop = became_unemp$prop),
           fill = project_pal[3]) +
  geom_text(aes(x = .18, y = "Unemployed"), size = 3.5, label = glue::glue("{paste(became_unemp[c('n','n_n')],
                              collapse = '/')} Previously Employed"),
             color = project_pal[4],
             fill = project_pal[3])
```
```{r eval=F, include=F}
item <- "res_cat"
sym_item <- sym(item)
wrangled %>% group_by_at(vars(!!sym_item, race_census, weight)) %>%
      summarize(n = sum(!!sym_var, na.rm = TRUE),
                denom = sum(!is.na(!!sym_var)),
                prop = mean(!!sym_var, na.rm = TRUE)) %>%
  mutate(prop_weighted = prop*weight) %>%
  #na.omit %>%
  filter(n > 5) %>%
  group_by(!!sym_item) %>% summarize(prop_ave = mean(prop_weighted, na.rm = TRUE)) %>%
  
  mutate_if(labelled::is.labelled, labelled::to_character)
```

# 2.2)Households whose income dropped below the poverty line from 2019 to 2021 [12 & 13]
Run distribution over population
Run distribution by sub-demographics (a-k) and type of previous employment [13]
Compare and find gaps (test unequal proportions)

## Findings (one statistically significant finding with caveat):

20% of respondents starting below the median income level but above the poverty line, ended up below the poverty line after the pandemic.  This may result simply because this range is the smallest of the three, and because it is much closer to the poverty line.  (See first plot).  

```{r}
wrangled %>% count(inc_drop_pov, inc_dist) %>%
  mutate_if(is.labelled, labelled::to_character) %>% na.omit

make_plots(wrangled, by_vars = demographics, hyp_var = "inc_drop_pov",
           min = 7,
           title = "Respondents whose household income\ndropped below the poverty line", show = TRUE)["inc_dist"]

```

Likely, the few respondents who dropped below the poverty line who started above the median income bracket were originally close to the median income level.

```{r}
arranged
counted <-
  wrangled %>% filter(inc_dist == 3, inc_drop_pov == 1) %>% count(inc_before) %>% rename(dropped = n)

tibble(categories, names(categories))
inc_dist_plot #+
#  geom_point(data = arranged %>% right_join(counted) %>% mutate(mean = mean(min, max, na.rm = TRUE)),
#             aes(x = mean), alpha = 1, pch = 21, color = "red")
  
wrangled %>% filter(emp_after_un == 1) %>%
  count(emp_after)
```

Therefore, we can look for any parallel shifts in the top bracket of the variable **inc_dist** to below the median income level.  However, this change is not paralleled by a similar percentage decrease in household income of respondents starting above the median income to below the median.  Only 4% of respondents above the median income level dropped below it after the pandemic.

```{r}
wrangled %>% filter(inc_dist == 3) %>%
  summarize(prop = signif(mean(inc_drop_med, na.rm = TRUE), 2),
            n = sum(inc_drop_med, na.rm = TRUE),
            denom = sum(!is.na(inc_drop_med), na.rm = TRUE))
```

Still, 17% of the higher third of the income distribution variable did experience a negative change in income.  In order to better understand this statistic, it would be necessary to identify how much their income levels dropped.

```{r}
wrangled %>% filter(inc_dist == 3) %>%
  summarize(prop = signif(mean(inc_neg, na.rm = TRUE), 2),
            n = sum(inc_neg, na.rm = TRUE),
            denom = sum(!is.na(inc_neg), na.rm = TRUE))
```

# 2.3)People who are currently receiving unemployment benefits were more likely to not face a reduced 2021 household income [16,12,13]
Find respondents who indicated they are currently receiving unemployment benefits [16]
Find proportion of subset that have a higher or equivalent income in 2021 than they reported in 2019 [12 & 13]]
Compare predicted 2021 income with 2019 income to find positive or negative change
Find proportion not in subset that predicted a higher or equivalent income in 2021 than they reported in 2019 and compare (test unequal proportions)

## Findings  (sample size too small)

There were not enough respondents in this category to meaningfully analyze this hypothesis.
```{r echo=F}
wrangled %>% count(unemp_ben) %>% mutate_if(is.labelled, labelled::to_character)

wrangled %>% filter(unemp_ben == 1) %>% count(inc_neg)
```

# 2.4)People who were unemployed before March 2020 were more likely to have a reduced 2021 household income [14,12,13]
Find respondents who indicated were unemployed before March 2020 [14]
Find proportion of subset that reported a higher or equivalent income in 2021 than they reported in 2019 [12 &13]
Compare predicted 2021 income with 2019 income to find positive or negative change
Find proportion not in subset that predicted a higher or equivalent income in 2021 than they reported in 2019 and compare (test unequal proportions)

## Findings (no statistically significant finding)

There was no statistically significant finding.  However, it is important to note that the sample size was quite small.  Only 8 unemployed people recorded a negative income change throughout the pandemic.

```{r}
sum(wrangled$emp_before_un)
mean(wrangled$emp_before_un)

wrangled %>% count(emp_before_un, inc_neg) %>% mutate_if(is.labelled, labelled::to_character) %>% na.omit

make_plots(wrangled, by_vars = "emp_before_un", hyp_var = "inc_neg",
           title = "Proportion of Respondents to experience\nan Adverse Income Change")
```

# 2.5)People who worked non-full-time jobs were more likely to foresee a reduced 2021 income [14,12,13]
Find respondents who indicated they work a not full-time job in 2019, 2021 (run both) [14]
Not full-time job == work part-time, freelance or consultant, gig worker, small business owner
Find proportion of subset that stated a higher or equivalent income in 2021 than they reported in 2019 [12 &13]
Compare 2021 income with 2019 income to find positive or negative change
Find proportion of full-time workers that have a higher or equivalent income in 2021 than they reported in 2019 and compare (test unequal proportions

## Findings (no statistically significant result)

```{r}
wrangled %>% filter(emp_before_part_time == 1) %>% count(emp_before)

make_plots(df = wrangled, by_vars = "emp_before_part_time", hyp_var = "inc_neg", show = "yes")
```

# 2.6)People who had difficulty paying bills in the past year [20]
Run distribution over population
Run distribution by sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

## Findings (some statistically significant findings)

- there are many demographics that have statistically significant differences in proportions, which mostly conform to expectations (e.g. **race_census**, **not_eng**, **sch_level_cat**, **hh_ch_0_17_bi**, **emp_status** before and after)
- notably, households with seniors and elderly respondents appeared to have less difficulty paying their bills

```{r}
mean(wrangled$diff_bill, na.rm = TRUE)

make_plots(df = wrangled, demographics, "diff_bill", min = 10, title = "Proportion of Respondents who had difficulty\npaying bills in the past year")[-6]
```

# 2.7)People who had difficulty paying rent in the past year [20]
Run distribution over population
Run distribution by sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

## Findings (some statistically significant findings)

```{r}
mean(wrangled$diff_rent, na.rm = TRUE)

make_plots(df = wrangled, demographics, "diff_rent", min = 10, title = "proportion of respondents who had difficulty\npaying rent in the past year")
```

# 2.8)Households that were financially unstable in the past year [20]
Run binary distribution over population
Indicators: experienced food running out, difficulty paying bills, difficulty paying rent
Yes =1+ indicators
No = 0 indicators
Run binary distribution by sub-demographics (a-k) and employed/unemployed/unemployed and currently receiving unemployment benefits
Compare and find gaps (test unequal proportions)
Run continuous distribution over population
Indicators: experienced food running out, difficulty paying bills, difficulty paying rent
Very financially unstable = 3 indicators
**Somewhat financially unstable = 1-2 indicators**
Not financially unstable = 0 indicators

## Findings (some statistically significant findings)

- respondents who owned their residences had statistically significantly less financial insecurity
- again, respondents who spoke a language other than english at home experienced more financial insecurity
- again, elderly respondents and households with seniors had less financial insecurity
- on the other hand, households with children had more financial insecurity
- Black and Hispanic respondents had more financial insecurity than white respondents
- school level was positively associated with financial security (more school, more security)
- and obviously, unemployed respondents were more financially unstable than employed respondents

```{r}
mean(wrangled$fin_unstable, na.rm = TRUE)

wrangled %>% filter(is.na(diff_ran_out), !is.na(diff_bill))

make_plots(wrangled, demographics, hyp_var = "fin_unstable", min = 10)
```

# 2.9)Households that experienced food insecurity in the past year [20]
Run binary distribution over population
Indicators: worried about food running out, ran out of food/ unable to afford food 
Yes = 1+ indicator
No = 0 indicators
Run continuous distribution over population
Indicators: worried about food running out, ran out of food/ unable to afford food 
Very food insecure = 2 indicators
Somewhat food insecure = worried about food not lasting (OR experienced food bought didn’t last i.e. 1 indicator?)
Not food insecure = 0 indicators

## Findings (some statistically significant findings)

- respondents who owned their residences had statistically significantly less food insecurity (10%) compared to respondents without a permanent residence (50%)
- again, respondents who spoke a language other than english at home experienced more food insecurity
- again, elderly respondents, households with seniors, and retired respondents all experienced less food insecurity
- on the other hand, households with children had more food insecurity (responds to hyp 2.10)
- Black and Hispanic respondents had significantly more food insecurity than white respondents
- school level and income bracket was negatively associated with food insecurity (more school, more security)
- and obviously, unemployed respondents were more financially unstable than employed respondents

```{r}
mean(wrangled$food_insec, na.rm = TRUE)

make_plots(wrangled, demographics, "food_insec", min = 7)[-6]
```

# 2.10)Households with children were more likely to experience food insecurity in the past year [24,20]
Find respondents who had at least one child (child under 4 or school-aged child) [24]
Find proportion of subset who are considered food insecure [20] (use binary definition above)
Find proportion not in subset who are considered food insecure and compare (test unequal proportions)

## Findings (statistically significant finding)

Reiterates findings in previous hypothesis.  Families with children experienced more food insecurity than families without.

```{r}
mean(wrangled$hh_ch_0_17_bi == 1 & wrangled$food_insec == 1, na.rm = TRUE)

make_plots(wrangled, "hh_ch_0_17_bi", hyp_var = "food_insec")
```

# 2.11)Respondents who experienced a reduced income were more likely to rate government response poorly [12 &13]
Run binary distribution over rating government response question 
Poor=Poor or Very Poor
Not Poor=Good, Excellent, Average
Find proportion which rated government services poorly [31]
              Poorly=Poor or Very Poor
Find subset of population who witnessed a reduced income
Compare with others who did not

## Findings (No statistically significant result)

```{r}
make_plots(wrangled,
           by_vars = "inc_neg", hyp_var = "rate_gov_cit_bad", show = "yes",
           title = "Proportion of respondents who\nrated city government services poorly")
```

# 2.12)Respondents who have a low income (below median income) are more likely to experience  violence [12, 13, 34 ]
Find proportion who faced **discrimination** or violence [34]
Find subset who are below median income[13]
Compare and contrast with group who are above median income within the larger proportion

## Findings (statistically significant difference on 90% confidence level)

Respondents below median income were more likely to experience violence or abuse.  The differing proportions are significant on the 90% confidence level.

```{r}
mean(wrangled$exp_ab_or_vi, na.rm = TRUE)

make_plots(wrangled, by_vars = "inc_be_med_after", hyp_var = "exp_ab_or_vi")
```

# 2.13)Respondents who have a low income (below median income) are more likely to be worried about transport while their child attends in-person school 
Find proportion who cite transport as one of their concerns when their child [27]
Find subset below median income [13]
Compare with respondents above median income

## Findings (No statistically significant result)

```{r}
make_plots(wrangled %>% filter(hh_ch_0_17_bi == 1), "inc_be_med_after", "con_trans")
```

```{r include=F, eval=F}
drive_upload(media = "wrangled_financial_security.pdf", path = paste0("Communities Speak/Subteams/Data Subteam/Data Findings + VIZ_IS_2/Findings/wrangled_Financial_Security_FULL_ARIELLE_0404.pdf"))
```

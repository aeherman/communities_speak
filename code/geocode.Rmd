---
title: "geocode"
author: "Arielle Herman"
date: "2/12/2022"
output: html_document
---
```{r}
library(ggmap)
library(tidyverse)
readRDS("../data/processed/survey.rds")
```


## geocode

```{r eval=F}

# doesn't always but the name of the borough

today <- gsub("-", "", Sys.Date())
borough_names <- c("manhattan", "new york", "bronx", "staten island", "brooklyn", "queens")
geocoded_file_path <- paste0("../data/processed/zipcodes_geocoded", today, ".csv")

if(file.exists(geocoded_file_path)) {
  zipcodes_geocoded <- read_csv(geocoded_file_path)
} else {
  zipcodes <- survey %>% filter(!is.na(q3))
  zipcodes_geocoded <- zipcodes %>%
    ggmap::mutate_geocode(q3, output = "more") %>%
    #filter(borough_coded = str_extract())
    select(responseid, q3, address)
  write_csv(zipcodes_geocoded, geocoded_file_path)
}

zipcodes_geocoded %>% group_by(burough) %>% count

# coding the intersections is less accurate
#intersections <- survey %>% filter(!is.na(q4))
#geocoded <- intersections %>% ggmap::mutate_geocode(q4, output = "more")

## however, there are three postal codes that the geocoding fails to recognize
zipcodes_geocoded %>%
  arrange(responseid) %>% select(responseid, address, q3, q4, type) %>%
  filter(responseid %in% c("r_1gafr4up5ko8gyd", "r_1qb2mivxdjbz2q1", "r_2tnhe7vqp6gyj3z"))

## example
wrong <- ggmap::geocode(postalcode = "10368", output = "more")

## also doesn't work to paste intersection and geocode together
#geocode_full_address <- survey %>%
#  filter(!is.na(q3) | !is.na(q4)) %>%
#  mutate(full_address = paste(q4, q3, sep = ", ")) %>%  mutate_geocode(full_address, output = "more")
1+1
```

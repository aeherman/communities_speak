---
title: "plan_of_analysis"
author: "Arielle Herman"
date: "2/11/2022"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    df_print: paged
---

```{r setup, warning=F, message=F, include=F}
library(tidyverse)
library(haven)
library(gfonts)
library(ggVennDiagram)
wrangled <- read_dta("../data/output/wrangled20220403.dta") %>%
  mutate_if(is.character, na_if, "")
source("functions/communities_speak_theme.R")
source("thresholds.R")
theme_set(project_theme)
#use_font("open-sans", "functions/css/open-sans.css")

#```css
#body {font-family: 'Open Sans', open-sans;}
#```
```


```{r warning=F, message=F, include=F}
#use_font("open-sans", "functions/css/open-sans.css")
poa <- wrangled %>% mutate(
  # demographics
  emp_status_before = case_when(
    str_detect(emp_before, "unemp") ~ "unemployed",
    str_detect(emp_before, "full|part|free|gig|small|home|student") ~ "employed",
    str_detect(emp_before, ";") ~ "multiple_other",
    TRUE ~ emp_before),
  emp_status_after = case_when(
    str_detect(emp_before, "unemp") ~ "unemployed",
    str_detect(emp_after, "full|part|free|gig|small|home|student") ~ "employed",
    str_detect(emp_after, ";") ~ "multiple_other",
    TRUE ~ emp_after),
  res_cat = labelled::to_character(res_type),
  res_cat = case_when(
    str_detect(res_cat, "public") ~ "public",
    str_detect(res_cat, "owner") ~ "owner",
    str_detect(res_cat, "renter") ~ "renter",
    str_detect(res_cat, "not have") ~ "no permanent residence",
    TRUE ~ res_cat),
  sch_level_cat = labelled::to_character(sch_level),
  sch_level_cat = case_when(
    str_detect(sch_level_cat, "high school|some college") ~ sch_level_cat,
    str_detect(sch_level_cat, "bach|ass") ~ "undergraduate degree",
    str_detect(sch_level_cat, "doct|mast|prof") ~ "graduate degree"
  ),
  unemployed = emp_after == "unemployed", # newly unemployed
  decade = paste0(floor(age/10)*10, "s"),
  
  # hypotheses
  emp_change = emp_before != emp_after,
  # 1.4 inc_be_med_b
  # 1.5
  sch_bach = factor(ifelse(str_detect(labelled::to_character(sch_level), "(?<!no )degree"), "BA plus", labelled::to_character(sch_level))),
  # 1.6
  ins_has = factor(ifelse(!str_detect(ins, "do"), "has insurance", "doesn't have insurance")),
  # 1.7) People who were on private insurance were least likely to face changes in job status [14,15,21]
  # ins_prvt
  # 1.8)Higher paid employees (above median income) were less likely to return to working in-person [12,13,18]
  inc_ab_med = inc_after > 8 & inc_before > 8,
  part_time = case_when(
    emp_before_wrk_ft == 0 & emp_before_wrk_pt == 1 | emp_before_fl == 1 | emp_before_gig == 1 | emp_before_sb == 1 ~ 1,
    emp_before_wrk_ft == 1 ~ 0
  ),
  fin_unstable = diff_ran_out == 1 & diff_bill == 1 | diff_bill == 1 & diff_rent == 1 | diff_rent == 1 & diff_ran_out == 1,
  food_insecurity = diff_ran_out == 1 | diff_worr == 1
  )
saveRDS(poa, file = "../data/output/poa.rds")
#hyps <- c("emp_change")
#dem <- "emp_status_b"
```

# 1.2) People who are currently unemployed who were not unemployed in before the pandemic (March 2020)  [14&15]

```{r, include=F}
# 1.2.1 Run distribution over population
poa %>% count(emp_status_b) %>% mutate(time = "2020") %>% rename(emp_status_a = emp_status_b) %>%
  bind_rows(count(poa, emp_status_a) %>% mutate(time = "2021")) %>%
  group_by(time) %>% mutate(prop = round(n/sum(n), digits = 4)*100) %>%
  filter(emp_status_a %in% c("disabled", "employed", "unemployed", "retired")) %>%
  ggplot(aes(x = time, y = prop, color = emp_status_a, group = emp_status_a)) +
  geom_point(aes(size = prop)) + geom_line(show.legend = FALSE) +
  xlab(NULL) + ylab(NULL) + geom_vline(xintercept = 1.5, lty = "dashed") +
  scale_color_manual(values = project_pal)

# Run distribution by sub-demographics(a-k)
# two versions of the plots
dems_employment <- c(str_subset(demographics, "emp_status", negate = TRUE))
dems_employment <- setNames(dems_employment, dems_employment)

lapply(dems_employment, function(item) {
  sym_item <- sym(item)
  
  reshaped <- poa %>% count(dem = labelled::to_character(!!sym_item),
                            unemployed = emp_status_b == "unemployed") %>% mutate(time = "2020") %>%
    bind_rows(poa %>% count(dem = labelled::to_character(!!sym_item),
                            unemployed = emp_status_a == "unemployed") %>% mutate(time = "2021")) %>%
    group_by(time, dem) %>% mutate(denom = sum(n), prop = round(n/denom, digits = 4)) %>%
    filter(unemployed, !str_detect(dem, "prefer not"))
  
  plot <- reshaped %>% ggplot(aes(x = time, y = prop, color = dem, group = dem)) +
    geom_point(aes(size = denom), shape = 21) + geom_line(show.legend = FALSE) +
    scale_y_continuous(labels = scales::percent) +
    xlab(NULL) + ylab(NULL) + scale_color_discrete(guide = "legend", name = item) +
    ggtitle(glue::glue("Percent Newly Unemployed by {stringr::str_to_title(item)}")) + project_theme
  
  return(plot)

})

item <- "sch_level_cat"

min_exclude <- 10
```

The following plots indicate different demographics whose proportions of individuals who lost there jobs during the pandemic.  Categories with fewer than r`min_exclude` responses were excluded from the calculation.  The p-values are provided on the plots.

```{r}
plots <- make_plots(df = filter(poa, !str_detect(emp_before, "unemp")),
           dems = dems_employment, var = "unemployed", min = 5)
length(filter(poa, !str_detect(emp_before, "unemp"), borough == "bronx")$unemployed == 1)
plots$not_eng <- plots$not_eng +
  ggtitle("Percent Newly Unemployed by\nwhether or not English is Spoken at Home") +
  scale_y_discrete(labels = c("English", "Not English"))
plots$hh_ch_0_17_bi <- plots$hh_ch_0_17_bi +
  ggtitle("Percent Newly Unemployed by Presence of Children at Home")
plots$inc_dist <- plots$inc_dist +
  ggtitle("Percent Newly Unemployed by Income Category")
#plots$res_cat <- plots$res_cat + ggtitle("Percent Newly Unemployed by Residence Category")
#plots$race_weight <- plots$race_weight + ggtitle("Percent Newly Unemployed by Race")
plots$borough
```


# 1.3) Higher income employees were less likely to face adverse job status changes during the pandemic

```{r}
adverse <- poa %>%
  count(inc_be_med_before, emp_change, inc_neg) %>%
  group_by(inc_be_med_before) %>% mutate(denom = sum(n), prop = n/denom) %>%
  ungroup %>% mutate(width = denom/sum(n)) %>%
  filter(emp_change) %>% na.omit() %>%
  mutate_if(labelled::is.labelled, labelled::to_factor) %>%
  mutate(label = ifelse(str_detect(inc_neg, "neg"), "adverse", "neutral or positive")) %>%
  filter(label == "adverse")

p_adverse <- adverse %>% ggplot(aes(x = prop, y = inc_be_med_b#, fill = label
             #width = width
             )) + geom_col(fill = project_pal[4]) +
  ggtitle("Adverse Salary Changes by Income Category in 2020") +
  scale_fill_manual(values = project_pal[c(4)]) +
  scale_x_continuous(label = scales::percent) +
  xlab(NULL) + ylab(NULL) +
  geom_text(aes(label = glue::glue("{scales::percent(prop)}\n{n}/{denom}")),
              color = project_pal[1], hjust = 1.2) +
  labs(subtitle = glue::glue("p-value: {signif(prop.test(adverse$n, adverse$denom)$p.value, 2)}"))


p_adverse 
  
```

# 1.5-1.6)

1.5) People with at least a Bachelorâ€™s degree were more/less likely to face job status changes during the pandemic [11, 14,15]
1.6) People who had insurance (any form) were less likely to face changes in job status [21,14,15]

```{r}
#table(poa$ins[str_detect(poa$ins, ";")])
new_variables <- c("inc_be_med_before", "sch_bach", "ins_has", "ins_prvt")
new_variables <- setNames(new_variables, new_variables)
item <- "sch_bach"

make_plots(df = poa %>% mutate(inc_neg = inc_neg == 1),
           dems = new_variables,
           var = c("emp_change", "inc_neg"), min = 5,
           title = "Proportion to Experience an Adverse job change")

df %>% mutate(emp_neg = emp_change == 1 & inc_neg == 1) %>%
  group_by_at(item) %>%
  summarize(n = sum(emp_neg, na.rm = TRUE),
            denom = sum(!is.na(emp_neg)),
            prop = mean(emp_neg, na.rm = TRUE)) %>%
  na.omit %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

df %>% group_by(sch_bach, emp_change, inc_neg == 1) %>%
  count() %>% group_by(sch_bach) %>% na.omit %>%
  mutate(prop = round(n/sum(n), digits = 4), denom = sum(n)) %>%
  filter_if(is.logical, ~TRUE == .) %>%
  filter(!str_detect(sch_bach, "prefer|;")) %>%
  ungroup %>% mutate(width = denom/sum(denom)) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

```

# 1.8, 1.13)

1.08) Higher paid employees (above median income) were less likely to return to working in-person [12,13,18]
1.13) Individuals with children were more likely to participate in hybrid work rather than full-time physical work
```{r}
# maybe we should make a variable that is all three categories (below, at above) or 
inc_1.8 <- c("inc_ab_med_before", "inc_be_med_before", "inc_dist", "hh_ch_0_17_bi")
names(inc_1.8) <- inc_1.8
#item <- inc_1.8[[4]]

make_plots(df = poa %>% mutate(wrk_vi = wrk %in% c(2,3)),
           dems = inc_1.8, var = "wrk_vi",
           title = "proportion who returned to work virtually or hybrid")
```

# 1.9-1.11)

1.09) People who are currently receiving unemployment benefits [16]
- only r`sum(poa$unemp_ben == 1, na.rm = TRUE)` people who are currently recieving unemployment benefits

1.10) People who are unemployed and are not receiving unemployment benefits because they expired [15 &16]

```{r}
dems_unemp <- str_subset(demographics, "un|emp", negate = TRUE)
dems_unemp <- setNames(dems_unemp, dems_unemp)

poa %>% count(unemp_ben) %>% mutate(label = labelled::to_factor(unemp_ben))

# chose just those categories that have over 20 respondents
item <- 2
lapply(c(2,4), function(item) {
  item_name <- names(attributes(poa$unemp_ben)$labels[item])
  mutated <- poa %>% mutate(unemp = unemp_ben == item)
  lapply(dems_unemp, function(dem) {
    sym_dem <- sym(dem)
    reshaped <- mutated %>%
      count(!!sym_dem, unemp) %>%
      group_by(!!sym_dem) %>% mutate(prop = round(n/sum(n), digits = 4), denom = sum(n)) %>%
      filter(unemp, !str_detect(!!sym_dem, "prefer|;")) %>% ungroup %>% mutate(width = denom/sum(denom))
  
    plot <- reshaped %>% ggplot(aes(x = prop,
                                  y = reorder(stringr::str_to_title(labelled::to_character(!!sym_dem)), -n)#, width = width, alpha = n
                                  )) +
      geom_col(fill = project_pal[4]) +
      scale_x_continuous(labels = scales::percent) +
      xlab(NULL) + ylab(NULL) + scale_color_discrete(guide = "legend", name = dem) +
      ggtitle(glue::glue("'{item_name}' by '{dem}'")) +
      project_theme +
      geom_text(aes(label = glue::glue("{scales::percent(prop)}\n{n}/{denom}")),
              color = project_pal[1], hjust = 1.2)
      
  
  return(plot)
  })
})

```

# 1.12) Unemployed people who have less than a bachelors degree are more or less likely to apply for unemployment benefits even if they qualify [11, 15,16]


```{r}

poa %>% count(emp_after_un, unemp_con = unemp_ben == 4, sch_bach = sch_bach == "BA plus") %>%
  mutate(prop = round(n/sum(n), digits = 4)) %>%
  na.omit %>% filter(unemp_con)  %>% mutate_if(labelled::is.labelled, labelled::to_character) %>%
  ggplot(aes(x = prop, y = reorder(sch_bach, -n), alpha = n)) +
      geom_col(fill = project_pal[4]) +
      scale_x_continuous(labels = scales::percent) +
      xlab(NULL) + ylab(NULL) + ggtitle("Percent of People who Didn't apply for Unemployment Benefits by whether or not they hold at least a BA") + project_theme

#mean(str_detect(labelled::to_character(poa$sch_level), "(?<!no )degree"))
#mean(!str_detect(poa$ins, "do"))
```

# validation

```{r}
poa %>% filter(str_detect(emp_after, "unemployed;|;unemployed")) %>%
  select(responseid, source, wrk, emp_after, emp_before) %>% mutate_if(labelled::is.labelled, labelled::to_character)

poa %>% count(wrk, emp_after) %>%
  filter(wrk == 4) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

filter(poa, wrk == 4, str_detect(emp_after, "full|part")) %>% select(responseid, source, wrk, emp_after, emp_before) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

filter(poa, wrk == 3, str_detect(emp_after, "unemp|dis")) %>% select(responseid, source, wrk, emp_after, emp_before) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

# everybody who started unemployed was still unemployed
poa %>% filter(!str_detect(emp_after, "un"), str_detect(emp_before, "un"), !is.na(unemp_ben)) %>% select(responseid, emp_before, emp_after, unemp_ben) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

# people who lost their jobs and did not get new ones
poa %>% filter(str_detect(emp_after, "un"), !str_detect(emp_before, "un"), !is.na(unemp_ben)) %>% select(responseid, emp_before, emp_after, unemp_ben) %>%
  mutate_if(labelled::is.labelled, labelled::to_character)

```

# 1.1

```{r include=F, eval=F}
lapply(demographics, function(dem) {
  sym_dem <- sym(dem)
  reshape <- poa %>% count(emp_change, !!sym_dem) %>% na.omit()
  
  if(is.character(reshape[[dem]])) {
    reshaped <- reshape %>% arrange(n) %>% mutate_at(vars(!!sym_dem), stringr::str_to_title)
  } else if(haven::is.labelled(reshape[[dem]])){
    reshaped <- reshape %>% arrange(!!sym_dem) %>%
      mutate_at(vars(!!sym_dem), ~stringr::str_to_title(haven::as_factor(.)))
  } else if (dem == "age") {
    reshaped <- reshape %>% mutate_at(vars(!!sym_dem), ~as.factor(floor(./10)*10)) %>%
      group_by(emp_change, !!sym_dem) %>% summarize(n = sum(n))
  } else {
    reshaped <- reshape %>%
      mutate_at(vars(!!sym_dem), ~stringr::str_to_title(as.factor(.))) %>% arrange(n)
      
  } 
  p <- reshaped %>% group_by(!!sym_dem) %>% mutate(prop = n/sum(n)) %>%
    filter(emp_change) %>%
    ggplot(aes(x = prop, y = !!sym_dem, fill = emp_change, alpha = n,
               show.legend = FALSE)) +
    geom_col() + xlab(NULL) + ylab(NULL) +
    scale_fill_manual(labels = rev(c(FALSE, TRUE)), values = project_pal) +
    #scale_x_reverse()
    theme(legend.position = "none")
  return(p)
})
# does not yet fix for double counting
wrangled %>%
  group_by(responseid, emp_change = emp_before != emp_after) %>%
  select(responseid, contains("race_"), -race_text, -race_twomore) %>%
  pivot_longer(cols = c("race_white", "race_black", "race_his_lat"),
               names_to = "category", values_to = "value") %>%
  filter(value != 0) %>% ungroup %>% count(category, emp_change) %>%
  ggplot(aes(x = n, y = category, fill = emp_change, alpha = n)) + geom_col(position = "fill") +
  scale_fill_manual(labels = rev(c(FALSE, TRUE)), values = c(project_pal[1], "white")) + scale_x_reverse()


race_df <- poa %>% select(responseid, race_white, race_black, race_his_lat) %>%
  pivot_longer(cols = c(race_white, race_black, race_his_lat), names_to = "cat", values_to = "value") %>%
  filter(value == 1)

race_list <- split(race_df$responseid, race_df$cat)

ggVennDiagram(race_list)

mean(poa$emp_after_dis)
mean(poa$emp_before_dis)
```

```{r warning=F, message=F, eval=F, include=F}
lapply(demographics, function(dem) {
  sym_dem <- sym(dem)
  reshape <- poa %>% count(inc_after, !!sym_dem)
  if(is.character(reshape[[dem]])) {
    reshaped <- reshape %>% arrange(n)
  } else if(haven::is.labelled(reshape[[dem]])){
    reshaped <- reshape %>% arrange(!!sym_dem) %>%
      mutate_at(vars(!!sym_dem), haven::as_factor)
  } else if (dem == "age") {
    reshaped <- reshape %>% mutate_at(vars(!!sym_dem), ~as.factor(floor(./10)*10)) %>%
      group_by(inc_after, !!sym_dem) %>% summarize(n = sum(n))
  } else {
    reshaped <- reshape %>% mutate_at(vars(!!sym_dem), ~as.factor(.)) %>% arrange(n)
  } 
  p <- reshaped %>%
    ggplot(aes(x = n, y = !!sym_dem, fill = inc_after, alpha = n)) +
    geom_col(position = "fill")# + xlab(dem)
  return(p)
})

# does not yet fix for double counting
wrangled %>%
  group_by(responseid, emp_change = emp_before != emp_after) %>%
  select(responseid, contains("race_"), -race_text, -race_twomore) %>%
  pivot_longer(cols = contains("race_"), names_to = "category", values_to = "value") %>%
  filter(value != 0) %>% ungroup %>% count(category, emp_change) %>%
  ggplot(aes(x = n, y = category, fill = emp_change, alpha = n)) + geom_col(position = "fill")
```

# ester's table
```{r}
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% count(race_weight, diff_cc) %>% drop_na %>% group_by(race_weight) %>% mutate(prop = n/sum(n)) %>%
  filter(diff_cc == 1)
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% group_by(race_weight) %>% summarize(prop = mean(need_cc, na.rm = TRUE)) %>%
  mutate(type = "Difficulty affording childcare") %>%
  bind_rows(wrangled %>% filter(hh_ch_0_17_bi == 1) %>%
              group_by(race_weight) %>% summarize(prop = mean(diff_cc, na.rm = TRUE)) %>%
              mutate(type = "Difficulty finding or relying on childcare")) %>%
  drop_na %>% filter(!str_detect(race_weight, "two|american")) %>%
  pivot_wider(id_cols = type, names_from = race_weight, values_from = prop) %>%
  mutate_if(is.double, ~glue::glue("{signif(., digits = 2)*100}%"))

wrangled %>% filter(hh_ch_0_17_bi == 1) %>% select(diff_cc, need_cc) %>% summarize_all(~glue::glue("{signif(mean(., na.rm = TRUE), 2)*100}%"))

filter(wrangled, hh_ch_0_17_bi == 1, race_weight == "asian", diff_cc == 1) %>% nrow


wrangled %>% filter(hh_ch_0_17_bi == 1) %>%
  group_by(race_weight) %>%
  summarize_at(vars(diff_worr, diff_ran_out, diff_bill, diff_rent),
                   ~mean(., na.rm = TRUE)) %>% #filter(diff_worr > .25) %>%
  left_join(
    wrangled %>% group_by(hh_ch_0_17_bi) %>%
    summarize_at(vars(diff_worr, diff_ran_out, diff_bill, diff_rent),
                   ~mean(., na.rm = TRUE)) %>%
      mutate_at(vars(hh_ch_0_17_bi), labelled::to_character)) %>%
  mutate_if(is.double, ~glue::glue("{signif(., digits = 2)*100}%")) %>%
  select(`household without children`, `household with children`, `black or african american`, `hispanic or latinx`, asian, `white (non-hispanic or latino)`)

wrangled %>% filter(hh_ch_0_17_bi == 1, race == "asian") %>% pull(diff_ran_out) %>% table(useNA = c("ifany"))
  count(diff_worr) %>% ungroup

wrangled %>% filter(hh_ch_0_17_bi == 1) %>% pull(att_sch_in_prsn) %>% mean(na.rm = TRUE)
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% pull(con_covid) %>% mean(na.rm = TRUE)
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% group_by(borough) %>% summarize(prop = mean(con_covid, na.rm = TRUE))
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% group_by(race_weight) %>% summarize(prop = mean(con_covid, na.rm = TRUE))
wrangled %>% group_by(hh_ch_0_17_bi) %>% summarize(prop = mean(boost %in% c(1,2), na.rm = TRUE))
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% group_by(borough) %>% summarize(prop = mean(find_cc == 0, na.rm = TRUE))
wrangled %>% filter(hh_ch_0_17_bi == 1) %>% group_by(race_weight) %>% summarize(prop = mean(need_cc, na.rm = TRUE))

# question: proportion of people who drop by demographics is the same as the people who stay in
# boostrapping (sample with replacement of the same size, what is the minimum sample size)
```

```{r eval=F}

ggsave(plots$borough, filename = "../visuals/unemployment_borough.png")
drive_upload(media = "../visuals/unemployment_borough.png",
             path = "Communities Speak/Subteams/Data Subteam/Data Findings + VIZ_IS_2/Viz/unemployment_borough0328.png",
             overwrite = TRUE)
ggsave(p_adverse, filename = "../visuals/adverse_employment_income.png")
drive_upload(media = "../visuals/adverse_employment_income.png",
             path = "Communities Speak/Subteams/Data Subteam/Data Findings + VIZ_IS_2/Viz/adverse_employment_income0328.png",
             overwrite = TRUE)

drive_upload(media = "plan_of_analysis.pdf", path = paste0("Communities Speak/Subteams/Data Subteam/Data Findings + VIZ_IS_2/Findings/POA_PARTIAL_ARIELLE_0326.pdf"))
```

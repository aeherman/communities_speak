---
title: "poa_access"
author: "Arielle Herman"
date: "4/9/2022"
output:
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
source("../../code/default_setup.R")
```

# 6.1)People who had difficulty accessing resources  [20]

Run binary distribution over population
Indicators: food, PPE, transportation,housing
Yes = 1+ indicators
No = 0 indicators
Run binary distribution by sub-demographics
Compare and find gaps (test unequal proportions)
Run categorical distribution over population
Run categorical distribution over sub-demographics
Compare and find gaps (test unequal proportions)

```{r}
attributes(wrangled$res_insec)$labels

mean(wrangled$res_insec, na.rm = TRUE)

wrangled %>%
  mutate(across(c(diff_ran_out, diff_ppe, res_insec, diff_trans, diff_hous), as.integer)) %>%
  pivot_longer(cols = c("diff_ran_out", "diff_ppe", "res_insec", "diff_trans", "diff_hous")) %>%
  select(name, value) %>% group_by(name) %>% summarize(value = mean(value, na.rm = TRUE)) %>%
  mutate(analysis_variable = labelled(as.integer(name == "res_insec"), c("All 4 types" = 1, "1 type" = 0))) %>%
  ggplot(aes(x = name, y = value, fill = labelled::to_factor(analysis_variable))) + geom_col() +
  xlab("Proportion of Respondents\n") + ylab("\nDifficulty") +
  ggtitle("Proportion of Respondents who experienced difficulty") +
  scale_fill_manual(NULL, values = project_pal)
# make a venn diagram

make_plots(wrangled, demographics, "res_insec", title = "Difficulty Accessing Resources")
```


# 6.2) Local resource utilized over each challenge[33]

Run distribution of each resource people would turn to for each challenge over population
Run distribution of each resource people would turn to for each challenge over sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

```{r}
mean(str_detect(wrangled$lr_cc, ";"), na.rm = TRUE)
# lots of respondents just marked off not sure

resource_qs <- c("lr_fam", "lr_gov", "lr_fb", "lr_np")
names(resource_qs) <- resource_qs

lapply(resource_qs, function(q) {
  
  sym_q <- sym(q)
  
  pattern <- str_replace(q, "_", "_stress_")
  replacement <- survey_codebook_labelled$to_name[str_which(survey_codebook_labelled$full_name,
                                                            pattern)]
  
  df <- wrangled %>% mutate(across(all_of(demographics),
                            ~str_replace_all(labelled::to_factor(.),
                                             c("transgender.*" = "transgender",
                                               "indigenous.*" = "Indigenous American"))))
  
  make_plots(df, by_vars = demographics, hyp_var = q,
             title = glue::glue("Respondents who would reach out to \n {replacement}"))
})
```

# 6.3)Which mode of transportation most frequently used [23]

Run distribution over population
Run distribution by sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

```{r}
wrangled %>% count(trans)

wrangled %>% ggplot(aes(x = trans)) + geom_histogram() 

lapply(demographics, function(dm) {
  sym_dm <- sym(dm)
  wrangled %>%
    mutate(across(!!sym_dm, ~str_replace_all(labelled::to_factor(.),
                                         c("transgender.*" = "transgender",
                                           "indigenous.*" = "Indigenous American")))) %>%
    group_by(!!sym_dm) %>% count(!!sym_dm, trans) %>%
    arrange(dm, desc(n)) %>%
    mutate(trans_new = ifelse(row_number() < 4, to_character(trans), "other")) %>%
    group_by(!!sym_dm, trans_new) %>% summarize(n = sum(n)) %>%
    group_by(!!sym_dm) %>% mutate(denom = sum(n), prop = n/denom) %>%
    arrange(dm, prop) %>%
    mutate(label = ifelse(row_number()<=3, scales::percent(prop), "")) %>%
    filter(denom > 1) %>% na.omit() %>%

    
    ggplot(aes(x = prop, y = reorder(!!sym_dm, prop), fill = trans_new)) +
    geom_col(position = "fill") +
    geom_text(aes(label = scales::percent(signif(prop, 2))), position = position_fill(0.5)) +
    ggtitle(dm) + xlab(NULL) + ylab(NULL)
})
```

# 6.5) People who experienced difficulty accessing transportation in the past year [20]

Run distribution over population
Run distribution by sub-demographics (a-k)
Compare and find gaps (test unequal proportions)

```{r}
mean(wrangled$diff_trans, na.rm = TRUE)

make_plots(wrangled, demographics, "diff_trans", title = "Difficulty finding transportation") #title added by Brendan
```

# 6.6) People who are renting public housing or with public assistance were more likely to experience difficulty finding housing in the past six year 

Find respondents who are renters of public housing or rent with public assistance [19]
Find proportion of subset who indicated difficulty finding housing in the past year [20]
Find proportion not in subset who indicated difficulty finding housing in the past year and compare (test unequal proportions)

```{r}
#mean(wrangled$res_cat == 1)

res_cat_1 <- filter(wrangled, res_cat == 1)

(prop_insecure <- data.frame(table(res_cat_1$house_insec)) %>% rename("Having difficulty finding housing?" = Var1) %>% mutate(percent = Freq / sum(Freq))) #added by Brendan


make_plots(wrangled, "res_cat", "house_insec", title = "Difficulty finding housing")

```

# 6.7) Households below median income were more likely to have difficulty with transportation during the pandemic

Find three groups of population who are below median income in 2021 [13]
Find the proportion of each subset of people who had difficulty with transportation [20]
Compare and contrast the three groups on the basis of who faced the highest number of transportation issues and test unequal proportions

```{r}
mean(wrangled$inc_be_med_before, na.rm = TRUE)
wrangled %>% count(inc_dist, diff_trans) %>% mutate_if(is.labelled, to_character)

make_plots(wrangled, "inc_dist", "diff_trans", show = "yes", title = "Difficulty Accessing Transportation")
```


# 6.8)People with limited or no internet access are more likely to use friends and family as resources

Find respondents who have limited internet access or no internet access [22]
Find subset of respondents who are most likely to turn to friends/family for support [33]
it's not "most likely" but did or did not list them
Find proportion not in subset and compare (test unequal proportions)

```{r}
mean(wrangled$lr_fam, na.rm = TRUE)
mean(wrangled$internet_acc, na.rm = TRUE)
mean(wrangled$internet_lim, na.rm = TRUE)

count(wrangled, internet) %>% mutate_if(is.labelled, to_character) %>%
  ggplot(aes(x = n, y = reorder(internet, n))) + geom_col() + xlab(NULL) + ylab(NULL) + ggtitle("Internet Access Distribution")

make_plots(wrangled, "lr_fam", "internet_acc", title = "Strong or Limited Internet Access")
make_plots(wrangled, "lr_fam", "internet_lim", title = "Limited or No Internet Access")
```


# 6.9)People with limited or no internet access are more likely to use faith-based resources

Find respondents who have limited internet access or no internet access [22]
Find subset of respondents who are most likely to use faith-based resources [33]
Find proportion not in subset and compare (test unequal proportions)

```{r}
make_plots(wrangled, "lr_fb", "internet_acc", title = "Strong or Limited Internet Access", show = TRUE)
make_plots(wrangled, "lr_fb", "internet_lim", title = "Limited or No Internet Access", show = TRUE) #show set = true here for both by Brendan
```

# 6.10) Households below median income are more likely to rate maintenance of parks and services as poor [13, 32]
Find proportion of respondents who are below median income or at median income [13]
Find subset of respondents who rated maintenance of parks and services as poor [32]
Find proportion not in subset and compare (test unequal proportions)

```{r}
make_plots(wrangled, "inc_dist", "rate_neigh_rec_bad", title = "Rated Maintenance of Parks and Services as poor or very poor")
```

